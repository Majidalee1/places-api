<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Socket.io Client</title>
</head>

<body>
  <h2>Socket.io Demo</h2>
  <p>Click the button to send message to server. You can find the message in the server terminal logs.
    And then, the answer from the server will show here.</p>

  <button type="button" onclick="myclick();">Click Me to Send a Message</button>
  <ul id="list"></ul>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    window.socket = io()
    socket.on('msg', data => {
      const li = document.createElement('li')
      li.innerText = 'received news with data: ' + data
      list.appendChild(li)
    })

    function myclick () {
      socket.emit('msg', {message: 'I clicked the button'})
    }

    // just like the cmd `ping`, used for testing the network speed
    window.ping = (count = 10, timeout = 1.5e4, debug = false, delay = 0) => {
      let [min, max, sum, num] = [99999, 0, 0, 0]
      let lastId, fail = 0, time
      const convert = (num) => parseFloat(num / 1e3).toFixed(2)
      const next = () => {
        if (++num < count) {
          send()
        } else {
          socket.off('PONG', onReceive)
          console.log(`count ${num}  fail ${fail}  min ${convert(min)}s  max ${convert(max)}s  avg ${convert(sum / (num - fail))}s`)
        }
      }
      const send = (init) => {
        lastId = Date.now() % 1e5
        socket.emit('PING', init ? {delay, debug, id: lastId} : lastId)
        timer = setTimeout(() => {
          if (timer) {
            console.log(`PING  ${lastId}  TIMEOUT`)
            fail++
            next()
          }
        }, timeout)
      }
      const onReceive = (id) => {
        if (id !== lastId) { return }
        if (timer) { clearTimeout(timer); timer = 0 }
        const duration = (Date.now() - id) % 1e5
        if (duration < min) { min = duration }
        if (duration > max) { max = duration }
        sum += duration
        console.log(`PING  ${id}  ${convert(duration)}s`)
        next()
      }
      socket.on('PONG', onReceive)
      send(true)
    }
  </script>
</body>
</html>
